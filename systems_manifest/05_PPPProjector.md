# Component Manifest: PPPProjector

## 1. Purpose and Role

`PPPProjector.js` (Probabilistic Projection Parsing Projector) is a utility component designed to assist `KerbelizedParserator` in processing contextual information. Its primary role is to take raw data items (abstractions, context elements) and transform them into "projections" suitable for injection into a `TimestampedThoughtBuffer`.

These projections typically include a calculated timestamp, a transformed representation of the original data, and a focus weight. The aim is to structure information in a way that helps the parser manage context, potentially identify temporal patterns, and aid in disambiguation or breaking circular reasoning (though the latter is a more advanced goal).

## 2. Key Methods and Core Logic

### Initialization (`constructor(config = {})`)
*   Merges the provided `config` with `DEFAULT_PPP_CONFIG` (defined within the module).
*   Stores the resulting configuration in `this.config`.
*   Logs the initialized configuration.

### `projectToTimestampedBuffer(data, buffer)`
*   **Purpose:** The main public method. Takes input `data` (can be a single item or an array of items) and a `buffer` instance (expected to be a `TimestampedThoughtBuffer`).
*   **Logic:**
    1.  Validates the `buffer` to ensure it has an `inject` method.
    2.  Ensures `data` is an array (wraps if it's a single item).
    3.  If `data` is empty, logs a warning and returns an empty array.
    4.  For each `item` in the `data` array, it generates a "projection object" with the following properties:
        *   `timestamp`: Determined by calling `this.calculateOptimalTimestamp(item, index)`.
        *   `projection`: The transformed data item, generated by `this.createProbabilisticProjection(item)`.
        *   `focusWeight`: A relevance/importance score, generated by `this.calculateFocusWeight(item)`.
    5.  Logs the count of generated projections.
    6.  Iterates through the generated `projections` and calls `buffer.inject(p.timestamp, p.projection, p.focusWeight)` for each.
    7.  Returns the array of generated projection objects.

### Helper Methods:

*   **`calculateOptimalTimestamp(item, index = 0)`:**
    *   Currently returns `Date.now() + index * this.config.timestampSpreadFactor`.
    *   The `timestampSpreadFactor` (from config) allows slight temporal separation if multiple items are projected simultaneously.
    *   Future enhancements could involve more sophisticated timestamp calculation based on item content or buffer state.

*   **`createProbabilisticProjection(item)`:**
    *   **Purpose:** Transforms the input `item` into a "projected" representation.
    *   **Logic (Current - Placeholder):**
        *   Determines a `projectedValue`:
            *   If `item` is a primitive, appends `"_projected"` to its string representation.
            *   If `item` is an object with `id` or `name`, creates a string like `"item_<id>_projected"` or `"<name>_projected"`.
            *   Otherwise, uses `"unknown_projected"`.
        *   Returns an object:
            ```json
            {
              "originalItem": item, // Reference to the original
              "projectionType": this.config.defaultProjectionType,
              "projectedValue": projectedValue,
              "confidence": Math.random() * 0.5 + 0.5, // Random confidence (0.5-1.0)
              "metadata": { "source": this.config.projectionSource }
            }
            ```
    *   The actual "probabilistic" nature or sophisticated projection logic is yet to be implemented; it currently performs basic type-based string manipulation.

*   **`calculateFocusWeight(item)`:**
    *   **Purpose:** Assigns a weight to the projection.
    *   **Logic (Current - Placeholder):**
        *   Returns a value based on `this.config.baseFocusWeight` plus/minus a random amount determined by `this.config.focusWeightVariability`.
        *   The result is clamped between 0 and 1.

## 3. Configuration (`this.config.pppProjectorConfig`)

The configuration is derived from `DEFAULT_PPP_CONFIG` within the module, which can be overridden by `pppProjectorConfig` (typically passed from `KerbelizedParserator` if it instantiates an internal `PPPProjector`).

*   **`defaultProjectionType` (String, Default: "generic_event"):**
    *   The default `projectionType` assigned to generated projections.
*   **`timestampSpreadFactor` (Number, Default: 10 milliseconds):**
    *   Used by `calculateOptimalTimestamp` to slightly separate timestamps for items projected in the same batch.
*   **`baseFocusWeight` (Number, Default: 0.5):**
    *   The baseline for calculating `focusWeight`.
*   **`focusWeightVariability` (Number, Default: 0.2):**
    *   Determines the random range around `baseFocusWeight` (e.g., 0.2 means +/- 0.1).
*   **`projectionSource` (String, Default: "default_ppp_instance"):**
    *   An identifier included in the metadata of generated projections.

## 4. Interaction with Other Components

*   **`KerbelizedParserator`:**
    *   May instantiate `PPPProjector` as an internal helper (`this.pppProjector`) if `config.pppProjectorConfig` is provided.
    *   If so, `KerbelizedParserator.projectToPPP()` (its internal context projection method) can delegate to this `PPPProjector` instance. Currently, it uses `this.pppProjector.createProbabilisticProjection()` if the instance exists.
*   **`TimestampedThoughtBuffer`:**
    *   `PPPProjector.projectToTimestampedBuffer()` directly calls the `inject()` method of the passed `buffer` instance (which is expected to be a `TimestampedThoughtBuffer`).
*   **Integration Test (`examples/test-pmk-integration.js`):**
    *   Demonstrates instantiating `PPPProjector` and `TimestampedThoughtBuffer` separately and using `projectToTimestampedBuffer` to populate the buffer.

This component provides foundational utilities for transforming and time-weighting contextual data before it's stored in the `TimestampedThoughtBuffer`.
